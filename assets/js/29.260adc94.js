(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{609:function(_,v,t){"use strict";t.r(v);var s=t(36),l=Object(s.a)({},(function(){var _=this,v=_.$createElement,t=_._self._c||v;return t("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[t("h2",{attrs:{id:"一、本文需要实现什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一、本文需要实现什么"}},[_._v("#")]),_._v(" 一、本文需要实现什么？")]),_._v(" "),t("p",[_._v("首先看下两张图片\n")]),t("div",{staticStyle:{display:"flex"}},[t("p"),_._v(" "),t("p",[t("img",{attrs:{src:"https://c2.im5i.com/2021/12/22/stsnd.png",alt:"stsnd.png"}})]),_._v(" "),t("p",[t("img",{attrs:{src:"https://c2.im5i.com/2021/12/22/stE74.png",alt:"stE74.png"}})])]),_._v(" "),t("p",[_._v("需要实现一个很常用的功能")]),_._v(" "),t("ul",[t("li",[t("p",[_._v("1、进入消息页面，显示当前用户的会话列表")])]),_._v(" "),t("li",[t("p",[_._v("2、进入聊天页面，发送接收消息")])])]),_._v(" "),t("h2",{attrs:{id:"二、需要考虑什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二、需要考虑什么"}},[_._v("#")]),_._v(" 二、需要考虑什么？")]),_._v(" "),t("h3",{attrs:{id:"_1、进行消息发送接收的技术-socket"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、进行消息发送接收的技术-socket"}},[_._v("#")]),_._v(" 1、进行消息发送接收的技术 socket")]),_._v(" "),t("h4",{attrs:{id:"socket的基础概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#socket的基础概念"}},[_._v("#")]),_._v(" socket的基础概念")]),_._v(" "),t("p",[_._v("http协议只管发送消息，发送完就结束了。而socket协议是长连接，一直保持连接状态。")]),_._v(" "),t("ul",[t("li",[_._v("创建\n使用new websocket()的方式新建一个socket实例")]),_._v(" "),t("li",[_._v("发送消息")]),_._v(" "),t("li",[_._v("接收消息")]),_._v(" "),t("li",[_._v("保持连接\n"),t("ul",[t("li",[_._v("心跳机制")])])]),_._v(" "),t("li",[_._v("关闭")])]),_._v(" "),t("h4",{attrs:{id:"发送接收流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发送接收流程"}},[_._v("#")]),_._v(" 发送接收流程")]),_._v(" "),t("p",[_._v("a发消息给b时会发生什么")]),_._v(" "),t("p",[_._v("a——>服务器——>b")]),_._v(" "),t("p",[_._v("a通过socket实例的send()方法发送，。")]),_._v(" "),t("p",[_._v("b通过socket的事件监听onmessage获取到信息。")]),_._v(" "),t("h4",{attrs:{id:"建立socket连接的验证"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建立socket连接的验证"}},[_._v("#")]),_._v(" 建立socket连接的验证")]),_._v(" "),t("p",[_._v("正式使用时，一般会先发送一个消息给服务器，带上本次访问的信息。")]),_._v(" "),t("p",[_._v("服务器根据信息进行验证，判断是否是正常使用，成功的话会建立连接，然后返回信息给使用者。")]),_._v(" "),t("p",[_._v("a——>服务器  (请求建立socket连接)")]),_._v(" "),t("p",[_._v("服务器——>a  (建立socket连接成功/失败)")]),_._v(" "),t("p",[_._v("失败的话，考虑是否需要重连")]),_._v(" "),t("h4",{attrs:{id:"心跳机制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#心跳机制"}},[_._v("#")]),_._v(" 心跳机制")]),_._v(" "),t("p",[_._v("首先明确上面的发送接收机制。")]),_._v(" "),t("p",[_._v("为了检测客户端和服务端是否处于正常的链接状态，每隔一段时间发一条固定格式的信息，同时客户端会确认服务器端是否还活着，如果还活着的话，就会回传一个数据包给客户端来确定服务器端也还活着。")]),_._v(" "),t("p",[_._v("这个就是心跳机制。")]),_._v(" "),t("h4",{attrs:{id:"项目里的一些问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#项目里的一些问题"}},[_._v("#")]),_._v(" 项目里的一些问题")]),_._v(" "),t("ul",[t("li",[_._v("什么时候建立socket连接？\n"),t("ul",[t("li",[_._v("用户登陆完之后建立 socket连接，确保在所有页面都能收到消息")])])]),_._v(" "),t("li",[_._v("接受消息之后怎么传递给所有页面？\n"),t("ul",[t("li",[_._v("目前我是通过vuex定义了unreadItem存储所有未读消息")])])]),_._v(" "),t("li")]),_._v(" "),t("h3",{attrs:{id:"会话列表"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#会话列表"}},[_._v("#")]),_._v(" 会话列表")]),_._v(" "),t("ul",[t("li",[_._v("会话列表界面\n"),t("ul",[t("li",[_._v("接口返回上线时的数据，所需内容：\n"),t("ul",[t("li",[_._v("未读消息数，")]),_._v(" "),t("li",[_._v("最后一条消息内容，")]),_._v(" "),t("li",[_._v("最后一条消息时间")])])]),_._v(" "),t("li",[_._v("过滤数据\n"),t("ul",[t("li",[_._v("接受到消息时过滤一下")]),_._v(" "),t("li",[_._v("和本地缓存的消息过滤一下")])])]),_._v(" "),t("li",[_._v("socket 接受到新的消息，可能是一个新的会话，需要重新获取会话列表")])])])]),_._v(" "),t("h3",{attrs:{id:"聊天框"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#聊天框"}},[_._v("#")]),_._v(" 聊天框")]),_._v(" "),t("h4",{attrs:{id:"发送功能"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发送功能"}},[_._v("#")]),_._v(" 发送功能")]),_._v(" "),t("ul",[t("li",[_._v("文字，直接提交字符串")]),_._v(" "),t("li",[_._v("表情，需要处理，通过正则匹配判断是否为表情\n"),t("ul",[t("li",[_._v("提交时，可以把类型设为 0，为了方便 文字 + 表情 一起发送")]),_._v(" "),t("li",[_._v("通过表情索引，远程请求 gif 文件")])])]),_._v(" "),t("li",[_._v("图片，消息类型为 1，需处理\n"),t("ul",[t("li",[_._v("input-file 选择本地图片，上传至服务器，返回图片在服务器的 url\n"),t("ul",[t("li",[_._v("第三方文件服务器，如 oss")]),_._v(" "),t("li",[_._v("公司内部文件服务器")])])]),_._v(" "),t("li",[_._v("本地预览\n"),t("ul",[t("li",[_._v("通过请求远程服务器获取远程 url")]),_._v(" "),t("li",[_._v("通过转码成 base64 直接显示")])])]),_._v(" "),t("li",[_._v("输入框怎么显示图片？\n"),t("ul",[t("li",[_._v("发送表情时，输入框只有一些文字。不支持图片显示？")])])])])])]),_._v(" "),t("h4",{attrs:{id:"聊天内容显示"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#聊天内容显示"}},[_._v("#")]),_._v(" 聊天内容显示")]),_._v(" "),t("ul",[t("li",[_._v("发送消息时，添加至当前数据，本地缓存")]),_._v(" "),t("li",[_._v("接受消息时，监听 socket，添加至当前数据，本地缓存")]),_._v(" "),t("li",[_._v("加载消息\n"),t("ul",[t("li",[_._v("进入页面时，获取第一页，滚动至底部")]),_._v(" "),t("li",[_._v("分页显示，一次 10 条，向上滚动加载下一页，数据加载至头部")]),_._v(" "),t("li",[_._v("加载下一页之后，滚动到上一页的最后一条消息")])])]),_._v(" "),t("li",[_._v("ui行高问题\n"),t("ul",[t("li",[_._v("消息里，表情和文字高度不一致，会影响行高，qq 也没有解决这个问题")])])])]),_._v(" "),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[_._v("参考")]),_._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_42000816/article/details/113307548",target:"_blank",rel:"noopener noreferrer"}},[_._v("uni-app使用websocket（封装、心跳检测）"),t("OutboundLink")],1),_._v("\nsocket.io 库")])]),_._v(" "),t("ul",[t("li",[_._v("小程序的问题，返回之后信息列表不正确")]),_._v(" "),t("li",[_._v("遇到的问题\n"),t("ul",[t("li",[_._v("socket连接失败，可以能格式不正确")]),_._v(" "),t("li",[_._v("socket过几秒钟之后中断，可能是后端设定了时间，或者是只能一端在线的情况下另一端登录了该账号")]),_._v(" "),t("li",[_._v("系统消息，需要怎么显示？\n"),t("ul",[t("li",[_._v("系统消息发送之后。")]),_._v(" "),t("li",[_._v("会话列表接口中无系统消息。\n")])])])])]),_._v(" "),t("li",[_._v("缓存部分，初步设定为两个缓存\n"),t("ul",[t("li",[_._v("unreadItems：所有的未读消息")]),_._v(" "),t("li",[_._v("allItems：所有的消息")])])]),_._v(" "),t("li",[_._v("根据缓存，生成的两个对象\n"),t("ul",[t("li",[_._v("talkMap：存储所有的会话对象，和每个会话对象的所有消息。")]),_._v(" "),t("li",[_._v("lastMap：存储所有的会话对象，以及每个会话对象的最后一条消息,未读消息数量。")])])])])])}),[],!1,null,null,null);v.default=l.exports}}]);